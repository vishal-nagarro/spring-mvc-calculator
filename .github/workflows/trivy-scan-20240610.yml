name: Trivy Security Scan

description: |  
  Run Trivy container image scans for critical and high vulnerabilities with recommendations report.

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  trivy-container-scan:
    runs-on: ubuntu-latest
    name: Trivy Container Image Scan
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Scan Docker image with Trivy
        id: trivy-scan
        uses: aquasecurity/trivy-action@0.21.0
        with:
          image-ref: vishalverma03/spring-mvc-calculator
          format: json
          severity: CRITICAL,HIGH
          exit-code: 0
          ignore-unfixed: true
          vuln-type: os,library
          scanners: vuln
          trivy-config: ''
          args: '--report --recommendations'
          output: trivy-results.json

      - name: Check Trivy scan for vulnerabilities
        run: |
          jq '.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL" or .Severity=="HIGH")' trivy-results.json > /dev/null 2>&1
          if [ $? -eq 0 ]; then
            echo "❌ Vulnerabilities found! Please review trivy-results.json"
            exit 1
          else
            echo "✅ No CRITICAL or HIGH vulnerabilities found."
          fi

      - name: Upload Trivy scan report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-results
          path: trivy-results.json
